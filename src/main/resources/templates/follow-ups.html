<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Follow Ups</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

	<link rel="stylesheet" th:href="@{/css/style.css}" />
	<style>
		#noFollowUpsTitle,
		#followUpsTable,
		#inquiryDetailsTable {
			display: none;
		}
	</style>
</head>

<body>

	<div th:replace="~{fragments/employee-sidebar :: frg-employee-sidebar}"></div>

	<div class="content row justify-content-center">
		<h2>Follow Ups</h2>
		<p>below are the followups list, please handle the customers carefully!! </p>

		<section class="card shadow p-5" style="width: 60%;">
			<div th:if="${SuccessMsg}" class="mb-3 alert alert-success" role="alert">
				<span th:text="${SuccessMsg}"></span>
			</div>
			<div th:if="${ErrorMsg}" class="mb-3 alert alert-danger" role="alert">
				<span th:text="${ErrorMsg}"></span>
			</div>
			<div class="mb-3">
				<label class="form-label"> Select Follow Up Date:</label>
				<input type="hidden" id="sessionEmpEmail" th:value="${sessionEmp.email}" />
				<input type="date" id="followUpDate" class="form-control" />
			</div>
			<h3 class="text-danger" id="noFollowUpsTitle">Sorry, No follow ups...!!</h3>
			<table id="followUpsTable" class="table table-striped table-hover table-bordered shadow mt-4">
				<thead class="table-dark">
					<tr>
						<th scope="col">Customer PhoneNo</th>
						<th scope="col">See more</th>
					</tr>
				</thead>
				<tbody id="followUpTableBody">

				</tbody>
			</table>
		</section>

		<section class="card shadow p-5 mt-5" style="width: 100%;" id="inquiryDetailsTable">
			<div class="mb-3">
				<h4 class="text-center text-primary">Discussion Details</h4>
				<h5 id="CustomerName" class="mt-4"></h5>
				<table class="table table-striped table-hover table-bordered shadow mt-4">
					<thead>
						<tr>
							<th>Interested Course</th>
							<th>Discussion</th>
							<th>Inquiry Type</th>
							<th>Call Type</th>
							<th>Status</th>
							<th>Date Of Inquiry</th>
							<th>Time Of Inquiry</th>
						</tr>
					</thead>
					<tbody id="inquiryDetailsTableBody">

					</tbody>
				</table>
				<button id="addNewDiscussionBtn" class="btn btn-primary">Add New Discussion</buttonid>
		</section>
		<div class="modal fade" id="inquiryModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">Continue Inquiry</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<!-- form or content for the old inquiry continuation -->
						<form th:action="@{/submitInquiryForm}" method="POST" th:object="${inquiry}">
							<input type="hidden" name="sourcePage" value="followUpPage">
							<div class="mb-3">
								<label class="form-label">Customer Phone Number:</label>
								<input type="text" name="phoneno" id="modalCustomerPhoneno" class="form-control"
									placeholder="Enter customer phone no." required />
							</div>
							<div class="mb-3">
								<label class="form-label">Customer Name:</label>
								<input type="text" name="name" id="modalCustomerName" class="form-control"
									placeholder="Enter customer name" required />
							</div>
							<div class="mb-3">
								<label class="form-label">Interested Course:</label>
								<input type="text" name="interestedCourse" class="form-control"
									placeholder="Enter interested Course" required />
							</div>
							<div class="mb-3">
								<label class="form-label">Discussion:</label>
								<textarea name="discussion" class="form-control" placeholder="Enter discussion"
									required></textarea>
							</div>
							<div class="mb-3">
								<label class="form-label">Inquiry Type:</label>
								<select name="inquiryType" class="form-select" required>
									<option value="" selected disabled required>Inquiry Type:</option>
									<option value="Call">Call</option>
									<option value="Mail">Mail</option>
									<option value="Website">Website</option>
									<option value="Social Network">Social Network</option>
									<option value="Friend Reference">Friend Reference</option>
									<option value="Advertisement">Advertisement</option>
									<option value="Other">Other</option>
								</select>
							</div>
							<div class="mb-3">
								<label class="form-label">Call Type:</label>
								<select name="callType" class="form-select">
									<option value="" selected disabled required>Call Type:</option>
									<option value="Inbound Call">Inbound Call (customer call to company)</option>
									<option value="Outbound Call">Outbound Call (company call to customer)</option>
								</select>
							</div>
							<div class="mb-3">
								<label class="form-label">Status:</label>
								<select id="status" name="status" class="form-select" onchange="toggleFollowUpDate()">
									<option value="" selected disabled required>Status</option>
									<option value="Interested - (follow up)">Interested - (follow up)</option>
									<option value="Interested - (closed)">Interested - (closed)</option>
									<option value="Not Interested - (closed)">Not Interested - (closed)</option>
									<option value="Purchased - (closed)">Purchased - (closed)</option>
									<option value="Others - (closed)">Others - (closed)</option>
								</select>
							</div>
							<div class="mb-3" id="modalFollowUpDate">
								<label class="form-label">FollowUpDate:</label>
								<input type="date" name="followUpDate" class="form-control"
									placeholder="Enter follow up date" />
							</div>
							<button type="submit" class="btn btn-primary">Submit discussion</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script>
		$(document).ready(function () {
			var todayDate = new Date().toISOString().split('T')[0];
			$("#followUpDate").val(todayDate);
			var email = $("#sessionEmpEmail").val();
			fetchFollowUpDetails(email, todayDate);

			$("#followUpDate").on("change", function () {
				var selectedDate = $(this).val();
				fetchFollowUpDetails(email, selectedDate);
			});
			function fetchFollowUpDetails(email, date) {
				$.ajax({
					url: "/api/myFollowUps",
					method: "GET",
					data: {
						empEmail: email,
						followUpdate: date
					},
					success: function (response) {
						if (response.length > 0) {
							$("#followUpTableBody").empty();
							$.each(response, function (index, followup) {
								var row = `
												<tr>
													<td>${followup.phoneno}</td>
													<td><button id="getDetailsBtn" data-phoneno="${followup.phoneno}" class="btn btn-primary"> Get details</button></td>
												</tr>
											`;
								$("#followUpsTable").show();
								$("#followUpTableBody").append(row);
								$("#noFollowUpsTitle").hide();
							});
						}
						else {
							$("#followUpsTable").hide();
							$("#noFollowUpsTitle").show();
							$("#inquiryDetailsTable").hide();
						}
					},
					error: function (error) {
						alert(error);
					}
				});
			}
			$(document).on("click", "#getDetailsBtn", function () {
				var phoneno = $(this).data("phoneno");
				//alert("Phoneno :"+phoneno);
				fetchInquiries(phoneno);
			});

			function fetchInquiries(phoneno) {
				$.ajax({
					url: "/api/searchInquiries",
					method: "GET",
					data: {
						phoneNumber: phoneno
					},
					success: function (response) {
						$("#inquiryDetailsTableBody").empty();
						if (response.length > 0) {
							$("#inquiryDetailsTable").show();
							$("#CustomerName").text("Customer Name: " + response[0].name);
							$("#modalCustomerPhoneno").val(response[0].phoneno);
							$("#modalCustomerName").val(response[0].name);
							$.each(response, function (index, inquiry) {
								var row = `
												<tr>
													<td>${inquiry.interestedCourse}</td>
													<td>${inquiry.discussion}</td>
													<td>${inquiry.inquiryType}</td>
													<td>${inquiry.callType}</td>
													<td>${inquiry.status}</td>
													<td>${inquiry.dateOfInquiry}</td>
													<td>${inquiry.timeOfInquiry}</td>
												</tr>`;
								$("#inquiryDetailsTableBody").append(row);
							});
						}
						else {
							alert("no data found");
						}
					},
					error: function (error) {
						console.log(error);
					}
				});
			}

			$(document).on("click", "#addNewDiscussionBtn", function () {
				$("#inquiryModal").modal("show");
			});

		});
		function toggleFollowUpDate() {
			var status = document.getElementById("status").value;
			var followUpDate = document.getElementById("modalFollowUpDate");
			if (status === "Interested - (follow up)") {
				followUpDate.style.display = "block";
			}
			else {
				followUpDate.style.display = "none";
			}
		}
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>
</body>

</html>